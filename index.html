<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard de Ganhos – Bancos de Imagem</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg-primary: #0a0e1a;
      --bg-secondary: #0f1623;
      --bg-tertiary: #1a2332;
      --card-bg: linear-gradient(135deg, rgba(26, 35, 50, 0.8) 0%, rgba(15, 22, 35, 0.9) 100%);
      --card-border: rgba(59, 130, 246, 0.15);
      --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      --accent-primary: #3b82f6;
      --accent-secondary: #1d4ed8;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --gradient-accent: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      --blur-backdrop: rgba(15, 22, 35, 0.85);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, #0c1320 100%);
      background-attachment: fixed;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      color: var(--text-primary);
      line-height: 1.6;
      overflow-x: auto;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 20%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(16, 185, 129, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(245, 158, 11, 0.05) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    .wrap {
      max-width: 1400px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    h1 {
      font-size: clamp(28px, 4vw, 36px);
      font-weight: 700;
      margin: 0 0 8px;
      background: var(--gradient-accent);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      color: var(--text-muted);
      font-size: 16px;
      font-weight: 400;
      margin-bottom: 32px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .subtitle::before {
      content: '';
      width: 4px;
      height: 4px;
      background: var(--accent-primary);
      border-radius: 50%;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin: 32px 0 40px;
    }

    .card {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      padding: 24px;
      box-shadow: var(--card-shadow);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--accent-primary), transparent);
      opacity: 0.6;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
      border-color: rgba(59, 130, 246, 0.3);
    }

    label {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      display: block;
      margin-bottom: 8px;
      letter-spacing: 0.025em;
    }

    select, button, input {
      width: 100%;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid rgba(59, 130, 246, 0.2);
      background: rgba(26, 35, 50, 0.6);
      backdrop-filter: blur(8px);
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 400;
      transition: all 0.2s ease;
    }

    select:focus, button:focus, input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      background: rgba(26, 35, 50, 0.8);
    }

    button {
      background: var(--gradient-accent);
      border: none;
      color: white;
      font-weight: 600;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 13px;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    .currency-rates {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }

    .kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 32px 0;
    }

    .kpi {
      text-align: center;
      position: relative;
    }

    .kpi .label {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 12px;
      font-weight: 500;
    }

    .kpi .value {
      font-size: clamp(24px, 3vw, 32px);
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
      background: var(--gradient-accent);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .kpi .delta, .kpi .info {
      font-size: 13px;
      font-weight: 500;
      opacity: 0.8;
    }

    .delta.ok { color: var(--success); }
    .delta.bad { color: var(--error); }

    .chart-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
      margin: 32px 0;
    }

    .chart-card {
      min-height: 400px;
      display: flex;
      flex-direction: column;
    }

    .table-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-top: 24px;
    }

    canvas {
      width: 100% !important;
      height: 360px !important;
      border-radius: 12px;
    }

    .table-container {
      overflow: hidden;
      border-radius: 16px;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: rgba(26, 35, 50, 0.3);
    }

    th, td {
      text-align: left;
      padding: 16px;
      border-bottom: 1px solid rgba(59, 130, 246, 0.1);
      font-size: 14px;
    }

    th {
      color: var(--text-secondary);
      font-weight: 600;
      background: rgba(26, 35, 50, 0.6);
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.05em;
    }

    tr:hover td {
      background: rgba(59, 130, 246, 0.05);
    }

    tfoot td {
      font-weight: 700;
      background: rgba(26, 35, 50, 0.8);
      border-top: 2px solid var(--accent-primary);
      color: var(--text-primary);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(59, 130, 246, 0.15);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 24px;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      color: var(--accent-primary);
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }

    .pill::before {
      content: '';
      width: 6px;
      height: 6px;
      background: var(--accent-primary);
      border-radius: 50%;
    }

    .footer {
      margin: 48px 0 24px;
      padding: 24px;
      background: rgba(15, 22, 35, 0.6);
      border: 1px solid rgba(59, 130, 246, 0.1);
      border-radius: 16px;
      color: var(--text-muted);
      font-size: 14px;
      line-height: 1.6;
    }

    .muted {
      color: var(--text-muted);
    }

    /* Responsive adjustments */
    @media (max-width: 1200px) {
      .chart-grid {
        grid-template-columns: 1fr;
      }
    }
    @media (max-width: 992px) { /* NOVO: Breakpoint para as taxas na tabela */
        .table-grid {
            grid-template-columns: 1fr;
        }
    }
    @media (max-width: 768px) {
      .wrap {
        padding: 24px 16px;
      }
      
      .controls {
        grid-template-columns: 1fr;
      }
      
      .kpis {
        grid-template-columns: 1fr;
      }

      .currency-rates {
        grid-template-columns: 1fr;
      }
    }

    /* Animation classes */
    .fade-in {
      animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Loading states */
    .loading {
      position: relative;
      pointer-events: none;
    }

    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 24px;
      height: 24px;
      margin: -12px 0 0 -12px;
      border: 2px solid rgba(59, 130, 246, 0.2);
      border-top: 2px solid var(--accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="wrap fade-in">
    <h1>Dashboard de Ganhos</h1>
    <div class="subtitle">Adobe Stock • Freepik • Shutterstock • Getty Images</div>

    <div class="controls">
      <div class="card">
        <label for="yearSel">Ano</label>
        <select id="yearSel"></select>
      </div>
      <div class="card">
        <label for="monthSel">Mês</label>
        <select id="monthSel"></select>
      </div>
      <div class="card">
        <label for="siteSel">Plataformas</label>
        <select id="siteSel" multiple size="4"></select>
      </div>
      <div class="card">
        <label for="currencySel">Moeda de exibição</label>
        <select id="currencySel">
          <option value="BRL" selected>BRL (R$)</option>
          <option value="USD">USD ($)</option>
          <option value="EUR">EUR (€)</option>
        </select>
        <div class="muted" style="margin-top:16px; font-size: 13px;">Taxas (editáveis):</div>
        <div style="margin-bottom: 12px;">
          <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
            <input id="useHistoricalRates" type="checkbox" style="width: auto; margin: 0;">
            <span style="font-size: 13px; color: var(--text-secondary);">Usar taxas históricas reais (API)</span>
          </label>
          <div id="rateStatus" class="muted" style="font-size: 12px; margin-bottom: 8px;"></div>
        </div>
        <div class="currency-rates" id="manualRates">
          <div>
            <label for="rateUsdBrl">USD → BRL</label>
            <input id="rateUsdBrl" type="number" step="0.0001" min="0" value="5.00">
          </div>
          <div>
            <label for="rateEurBrl">EUR → BRL</label>
            <input id="rateEurBrl" type="number" step="0.0001" min="0" value="6.00">
          </div>
        </div>
        <div class="muted" style="margin-top:16px; font-size: 13px;">Imposto (Freepik em EUR):</div>
        <div>
          <label for="taxFreepik">Freepik: Imposto %</label>
          <input id="taxFreepik" type="number" step="0.1" min="0" max="100" value="24">
        </div>
      </div>
      <div class="card" style="display:flex;align-items:flex-end">
        <button id="btnReset">Limpar filtros</button>
      </div>
    </div>

    <div class="kpis">
      <div class="card kpi">
        <div class="label muted">Total do período (líquido)</div>
        <div id="kpiTotal" class="value">—</div>
        <div id="kpiYOY" class="delta"> </div>
      </div>
      <div class="card kpi">
        <div class="label muted">Melhor mês (líquido)</div>
        <div id="kpiBest" class="value">—</div>
        <div class="muted info" id="kpiBestInfo"> </div>
      </div>
      <div class="card kpi">
        <div class="label muted">Pior mês (líquido)</div>
        <div id="kpiWorst" class="value">—</div>
        <div class="muted info" id="kpiWorstInfo"> </div>
      </div>
      <div class="card kpi">
        <div class="label muted">Ticket médio / mês (líquido)</div>
        <div id="kpiAvg" class="value">—</div>
        <div class="muted info" id="kpiCount"> </div>
      </div>
    </div>

    <div class="chart-grid">
      <div class="card chart-card">
        <canvas id="lineTotals"></canvas>
      </div>
      <div class="card chart-card">
        <canvas id="barPlatforms"></canvas>
      </div>
    </div>

    <div class="table-grid">
      <div class="card">
        <div class="pill">Detalhe por plataforma</div>
        <div class="table-container">
          <table id="tblPlatforms">
            <thead>
              <tr>
                <th>Plataforma</th>
                <th>Bruto</th>
                <th>Líquido</th>
                <th>% (sobre líquido)</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <td>Total</td>
                <td id="tblTotalBruto">—</td>
                <td id="tblTotal">—</td>
                <td>100%</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
      <div class="card">
        <div class="pill">Movimentação mensal</div>
        <div class="table-container">
          <table id="tblMonths">
            <thead>
              <!-- O cabeçalho agora é gerado dinamicamente -->
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="footer">
      <strong>💡 Dica:</strong> Selecione BRL para ver tudo convertido e somado; selecione USD para ver apenas plataformas em USD (valores nativos); selecione EUR para ver apenas plataformas em EUR (valores nativos). As taxas USD→BRL e EUR→BRL e o imposto do Freepik podem ser ajustados acima.
      <br><br>
      <strong>🌍 Taxas Históricas:</strong> Quando habilitadas, o sistema usa taxas de câmbio reais de cada mês via API (Frankfurter.app), proporcionando conversões mais precisas baseadas nos valores históricos reais.
    </div>
  </div>

<script>
// ======== CONFIGURAÇÃO DO ARQUIVO JSON ========
// Deixe o arquivo ganhos_sites.json na MESMA pasta do HTML.
const DATA_URL = "ganhos_sites.json";

const PT_MONTHS = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
const PT_MONTH_TO_NUM = {"janeiro":1,"fevereiro":2,"março":3,"marco":3,"abril":4,"maio":5,"junho":6,"julho":7,"agosto":8,"setembro":9,"outubro":10,"novembro":11,"dezembro":12};

let RAW = [];
let LINE, BAR;
let stateRates = { usd_brl: 5.00, eur_brl: 6.00 };
let historicalRates = new Map(); // Cache para taxas históricas
let useHistoricalRates = false;
let displayCurrency = 'BRL';
let taxFreepikPct = 24; // %

// Cache para evitar muitas requisições à API
const rateCache = new Map();

async function load(){
  const res = await fetch(DATA_URL);
  const json = await res.json();
  if (Array.isArray(json)) {
    RAW = json.map(r => ({
      year: r.year ?? null,
      month_num: r.month_num ?? (r.month_name ? (PT_MONTH_TO_NUM[String(r.month_name).toLowerCase()]||null) : null),
      month_name: r.month_name ?? (r.month_num ? PT_MONTHS[r.month_num-1] : null),
      platform: r.platform || "(Sem Plataforma)",
      amount: Number(r.amount||0)
    })).filter(r => r.year && r.month_num && !isNaN(r.amount));
  } else {
    RAW = flattenFromNested(json);
  }
  populateFilters();
  attachCurrencyHandlers();
  render();
}

function flattenFromNested(obj){
  // Espera: { sites: { "Adobe Stock": { "2024": { "janeiro": 10, ... } } } }
  const out = [];
  const sites = obj.sites || obj.SITES || {};
  for (const [platform, years] of Object.entries(sites)){
    for (const [yearStr, months] of Object.entries(years)){
      const y = parseInt(yearStr,10);
      if (!y || typeof months !== 'object') continue;
      for (const [mKey, val] of Object.entries(months)){
        const mnum = PT_MONTH_TO_NUM[String(mKey).toLowerCase()];
        if (!mnum) continue;
        const amount = (val==null || isNaN(Number(val))) ? 0 : Number(val);
        out.push({ year: y, month_num: mnum, month_name: PT_MONTHS[mnum-1], platform, amount });
      }
    }
  }
  return out;
}

// API para taxas históricas - Usando Frankfurter.app (gratuita e sem chave)
async function fetchHistoricalRate(from, to, date) {
  const cacheKey = `${from}-${to}-${date}`;
  
  if (rateCache.has(cacheKey)) {
    return rateCache.get(cacheKey);
  }

  try {
    const response = await fetch(`https://api.frankfurter.app/${date}?from=${from}&to=${to}`);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const data = await response.json();
    const rate = data.rates[to];
    
    if (rate) {
      rateCache.set(cacheKey, rate);
      return rate;
    }
  } catch (error) {
    console.warn(`Erro ao buscar taxa ${from}→${to} para ${date}:`, error);
  }
  
  return null;
}

async function loadHistoricalRates() {
  if (!useHistoricalRates || !RAW.length) return;
  
  const statusEl = document.getElementById('rateStatus');
  statusEl.textContent = 'Carregando taxas históricas...';
  statusEl.className = 'muted rate-loading';
  
  const uniqueDates = new Set();
  RAW.forEach(record => {
    const dateStr = `${record.year}-${String(record.month_num).padStart(2, '0')}-15`;
    uniqueDates.add(dateStr);
  });
  
  const dates = Array.from(uniqueDates).sort();
  let loadedCount = 0;
  let errorCount = 0;
  
  for (const date of dates) {
    try {
      const usdToBrl = await fetchHistoricalRate('USD', 'BRL', date);
      const eurToBrl = await fetchHistoricalRate('EUR', 'BRL', date);
      
      if (usdToBrl && eurToBrl) {
        historicalRates.set(date, {
          usd_brl: usdToBrl,
          eur_brl: eurToBrl
        });
        loadedCount++;
      } else {
        errorCount++;
      }
      
      statusEl.textContent = `Carregando... ${loadedCount}/${dates.length} períodos`;
      await new Promise(resolve => setTimeout(resolve, 100));
      
    } catch (error) {
      console.warn(`Erro ao carregar taxa para ${date}:`, error);
      errorCount++;
    }
  }
  
  if (loadedCount > 0) {
    statusEl.textContent = `✓ ${loadedCount} períodos carregados${errorCount > 0 ? ` (${errorCount} falhas)` : ''}`;
    statusEl.className = 'muted rate-success';
    render();
  } else {
    statusEl.textContent = '⚠ Falha ao carregar taxas históricas';
    statusEl.className = 'muted rate-error';
  }
}

function getHistoricalRate(from, to, year, month) {
  if (!useHistoricalRates || !historicalRates.size) {
    return null;
  }
  
  const dateStr = `${year}-${String(month).padStart(2, '0')}-15`;
  const rates = historicalRates.get(dateStr);
  
  if (!rates) return null;
  
  if (from === 'USD' && to === 'BRL') return rates.usd_brl;
  if (from === 'EUR' && to === 'BRL') return rates.eur_brl;
  if (from === 'BRL' && to === 'USD') return 1 / (rates.usd_brl || 1);
  if (from === 'BRL' && to === 'EUR') return 1 / (rates.eur_brl || 1);
  if (from === 'USD' && to === 'EUR') return (rates.usd_brl || 1) / (rates.eur_brl || 1);
  if (from === 'EUR' && to === 'USD') return (rates.eur_brl || 1) / (rates.usd_brl || 1);
  
  return null;
}

function platformCurrency(platform){
  const s = String(platform).toLowerCase();
  if (s.includes('freepik')) return 'EUR';
  return 'USD';
}

function attachCurrencyHandlers(){
  const sel = document.getElementById('currencySel');
  const usd = document.getElementById('rateUsdBrl');
  const eur = document.getElementById('rateEurBrl');
  const tax = document.getElementById('taxFreepik');
  const historical = document.getElementById('useHistoricalRates');
  const manualRates = document.getElementById('manualRates');
  
  displayCurrency = sel.value;
  stateRates.usd_brl = parseFloat(usd.value)||5.00;
  stateRates.eur_brl = parseFloat(eur.value)||6.00;
  taxFreepikPct = Math.max(0, Math.min(100, parseFloat(tax.value)||24));
  useHistoricalRates = historical.checked;
  
  manualRates.style.opacity = useHistoricalRates ? 0.5 : 1;
  manualRates.style.pointerEvents = useHistoricalRates ? 'none' : 'auto';
  
  sel.onchange = ()=>{ displayCurrency = sel.value; render(); };
  usd.oninput = ()=>{ stateRates.usd_brl = parseFloat(usd.value)||0; if(!useHistoricalRates) render(); };
  eur.oninput = ()=>{ stateRates.eur_brl = parseFloat(eur.value)||0; if(!useHistoricalRates) render(); };
  tax.oninput = ()=>{ taxFreepikPct = Math.max(0, Math.min(100, parseFloat(tax.value)||0)); render(); };
  
  historical.onchange = async ()=>{
    useHistoricalRates = historical.checked;
    manualRates.style.opacity = useHistoricalRates ? 0.5 : 1;
    manualRates.style.pointerEvents = useHistoricalRates ? 'none' : 'auto';
    
    if (useHistoricalRates) {
      await loadHistoricalRates();
    } else {
      document.getElementById('rateStatus').textContent = '';
      render();
    }
  };
  
  document.getElementById('btnReset').onclick = ()=>{
    document.getElementById('yearSel').value = "";
    document.getElementById('monthSel').value = "";
    [...document.getElementById('siteSel').options].forEach(o=>o.selected=true);
    document.getElementById('currencySel').value = 'BRL';
    document.getElementById('rateUsdBrl').value = '5.00';
    document.getElementById('rateEurBrl').value = '6.00';
    document.getElementById('taxFreepik').value = '24';
    document.getElementById('useHistoricalRates').checked = false;
    document.getElementById('rateStatus').textContent = '';
    historicalRates.clear();
    rateCache.clear();
    attachCurrencyHandlers();
    render();
  };
}

function convertAmount(amount, from, to, year = null, month = null){
  if (from === to) return amount;
  
  if (year && month && useHistoricalRates) {
    const historicalRate = getHistoricalRate(from, to, year, month);
    if (historicalRate) {
      return amount * historicalRate;
    }
  }
  
  const { usd_brl, eur_brl } = stateRates;
  if (from === 'USD' && to === 'BRL') return amount * usd_brl;
  if (from === 'EUR' && to === 'BRL') return amount * eur_brl;
  if (from === 'BRL' && to === 'USD') return amount / (usd_brl || 1);
  if (from === 'BRL' && to === 'EUR') return amount / (eur_brl || 1);
  if (from === 'USD' && to === 'EUR') return (amount * usd_brl) / (eur_brl || 1);
  if (from === 'EUR' && to === 'USD') return (amount * eur_brl) / (usd_brl || 1);
  return amount;
}

function unique(arr){return [...new Set(arr.filter(x=>x!=null))]}

function populateFilters(){
  const years = unique(RAW.map(d=>d.year)).sort((a,b)=>a-b);
  const sites = unique(RAW.map(d=>d.platform)).sort();
  const yearSel = document.getElementById('yearSel');
  const monthSel = document.getElementById('monthSel');
  const siteSel = document.getElementById('siteSel');

  yearSel.innerHTML = '<option value="">Todos os anos</option>' + years.map(y=>`<option>${y}</option>`).join('');
  monthSel.innerHTML = '<option value="">Todos os meses</option>' + PT_MONTHS.map((m,i)=>`<option value="${i+1}">${m}</option>`).join('');
  siteSel.innerHTML = sites.map(s=>`<option selected>${s}</option>`).join('');

  yearSel.onchange = render;
  monthSel.onchange = render;
  siteSel.onchange = render;
}

function getFilters(){
  const y = document.getElementById('yearSel').value;
  const m = document.getElementById('monthSel').value;
  const selSites = [...document.getElementById('siteSel').selectedOptions].map(o=>o.value);
  return {year: y?Number(y):null, month: m?Number(m):null, sites: selSites};
}

function fmt(n){
  const map = { BRL: ['pt-BR','BRL'], USD: ['en-US','USD'], EUR: ['de-DE','EUR'] };
  const [loc, cur] = map[displayCurrency] || ['pt-BR','BRL'];
  return n.toLocaleString(loc,{style:'currency',currency:cur});
}

function compute(){
  const f = getFilters();
  const base = RAW.filter(d=> (f.year? d.year===f.year : true) && (f.month? d.month_num===f.month : true) && (f.sites.includes(d.platform)) )
    .map(r=>{
      const cur = platformCurrency(r.platform);
      const isFreepik = cur==='EUR' && String(r.platform).toLowerCase().includes('freepik');
      const bruto = r.amount;
      const liquido = isFreepik ? bruto * (1 - taxFreepikPct/100) : bruto;
      return { ...r, native_currency: cur, bruto, liquido };
    });

  let rows;
  if (displayCurrency === 'BRL'){
    rows = base.map(r=>({ 
      ...r, 
      amount_conv_bruto: convertAmount(r.bruto, r.native_currency, 'BRL', r.year, r.month_num), 
      amount_conv: convertAmount(r.liquido, r.native_currency, 'BRL', r.year, r.month_num) 
    }));
  } else if (displayCurrency === 'USD'){
    rows = base.filter(r=> r.native_currency==='USD').map(r=> ({...r, amount_conv_bruto: r.bruto, amount_conv: r.liquido}));
  } else if (displayCurrency === 'EUR'){
    rows = base.filter(r=> r.native_currency==='EUR').map(r=> ({...r, amount_conv_bruto: r.bruto, amount_conv: r.liquido}));
  } else {
    rows = base.map(r=> ({...r, amount_conv_bruto: r.bruto, amount_conv: r.liquido}));
  }

  const byMonthKey = d=> `${d.year}-${String(d.month_num).padStart(2,'0')}`;
  const seriesMap = new Map();
  rows.forEach(d=>{ const k = byMonthKey(d); seriesMap.set(k,(seriesMap.get(k)||0)+d.amount_conv); });
  const series = [...seriesMap.entries()].map(([k,v])=>({key:k, value:v, year:+k.split('-')[0], month:+k.split('-')[1]})).sort((a,b)=> a.year-b.year || a.month-b.month);

  const platAgg = new Map();
  rows.forEach(d=>{ const o = platAgg.get(d.platform) || { bruto:0, liquido:0 }; o.bruto += d.amount_conv_bruto; o.liquido += d.amount_conv; platAgg.set(d.platform, o); });
  const platforms = [...platAgg.entries()].map(([name,vals])=>({name, bruto: vals.bruto, val: vals.liquido})).sort((a,b)=> b.val - a.val);

  const total = platforms.reduce((s,p)=>s+p.val,0);
  const totalBruto = platforms.reduce((s,p)=>s+p.bruto,0);
  const countMonths = unique(series.map(s=>`${s.year}-${s.month}`)).length;
  const avg = countMonths? total / countMonths : 0;

  const best = series.length? series.reduce((a,b)=> a.value>=b.value? a: b) : null;
  const worst = series.length? series.reduce((a,b)=> a.value<=b.value? a: b) : null;

  let yoy = null;
  if (f.month){
    const candidates = RAW.filter(d=> (f.sites.includes(d.platform)) && d.month_num===f.month).map(r=>{
      const cur = platformCurrency(r.platform);
      const isFreepik = cur==='EUR' && String(r.platform).toLowerCase().includes('freepik');
      const bruto = r.amount;
      const liquido = isFreepik ? bruto * (1 - taxFreepikPct/100) : bruto;
      return { ...r, native_currency: cur, liquido };
    }).filter(r=> displayCurrency==='BRL' ? true : r.native_currency===displayCurrency);

    const sumByYear = new Map();
    candidates.forEach(d=>{
      const val = (displayCurrency==='BRL') ? convertAmount(d.liquido, d.native_currency, 'BRL', d.year, d.month_num) : d.liquido;
      sumByYear.set(d.year, (sumByYear.get(d.year)||0) + val);
    });
    const curr = sumByYear.get(f.year||-1) || 0;
    const prev = sumByYear.get((f.year||0)-1);
    if (prev!=null && prev !== 0){ yoy = ((curr - prev) / prev) * 100; }
  }

  return {rows, series, platforms, total, totalBruto, avg, countMonths, best, worst, yoy};
}

// ======================= INÍCIO DAS ALTERAÇÕES =======================
function renderTables(state){
  const {platforms,total,series,rows,totalBruto} = state;
  // Plataformas
  const tb = document.querySelector('#tblPlatforms tbody');
  tb.innerHTML = platforms.map(p=>{
    const cur = platformCurrency(p.name);
    const pct = total? ((p.val/total)*100).toFixed(1) : '0.0';
    const moedaHint = (displayCurrency==='BRL') ? ` <span class="muted">(${cur})</span>` : '';
    return `<tr><td>${p.name}${moedaHint}</td><td>${fmt(p.bruto)}</td><td>${fmt(p.val)}</td><td>${pct}%</td></tr>`;
  }).join('');
  document.getElementById('tblTotal').textContent = fmt(total);
  document.getElementById('tblTotalBruto').textContent = fmt(totalBruto);

  // --- Meses ---
  // NOVO: Cabeçalho dinâmico para a tabela de meses
  const tbmHead = document.querySelector('#tblMonths thead');
  tbmHead.innerHTML = `
    <tr>
      <th>Mês</th>
      <th>Bruto</th>
      <th>Líquido</th>
      ${useHistoricalRates && displayCurrency === 'BRL' ? '<th>Taxa USD (→BRL)</th><th>Taxa EUR (→BRL)</th>' : ''}
    </tr>`;

  // Agregação por mês
  const byMonthKey = d=> `${d.year}-${String(d.month_num).padStart(2,'0')}`;
  const monthAgg = new Map();
  rows.forEach(d=>{
    const k = byMonthKey(d);
    const o = monthAgg.get(k) || { bruto:0, liquido:0, year:d.year, month:d.month_num };
    o.bruto += d.amount_conv_bruto; o.liquido += d.amount_conv; monthAgg.set(k,o);
  });

  // Renderização do corpo da tabela de meses
  const tbm = document.querySelector('#tblMonths tbody');
  tbm.innerHTML = [...monthAgg.values()].sort((a,b)=> a.year-b.year || a.month-b.month).map(s=>{
    const label = `${PT_MONTHS[s.month-1]}/${s.year}`;
    
    // NOVO: Lógica para buscar e formatar as taxas históricas
    let ratesCells = '';
    if (useHistoricalRates && displayCurrency === 'BRL') {
      const dateKey = `${s.year}-${String(s.month).padStart(2, '0')}-15`;
      const rates = historicalRates.get(dateKey);
      
      const usdRate = rates && rates.usd_brl ? rates.usd_brl.toFixed(4) : '—';
      const eurRate = rates && rates.eur_brl ? rates.eur_brl.toFixed(4) : '—';
      
      ratesCells = `<td>${usdRate}</td><td>${eurRate}</td>`;
    }
    
    // ALTERADO: Adiciona as novas células (ratesCells) no final da linha
    return `<tr><td>${label}</td><td>${fmt(s.bruto)}</td><td>${fmt(s.liquido)}</td>${ratesCells}</tr>`;
  }).join('');
}
// ======================= FIM DAS ALTERAÇÕES =======================


function renderKpis(state){
  const {total, avg, best, worst, countMonths, yoy} = state;
  document.getElementById('kpiTotal').textContent = fmt(total);
  document.getElementById('kpiAvg').textContent = fmt(avg);
  document.getElementById('kpiCount').textContent = countMonths? `${countMonths} mês(es)` : '';
  if (best){
    document.getElementById('kpiBest').textContent = fmt(best.value);
    document.getElementById('kpiBestInfo').textContent = `${PT_MONTHS[best.month-1]}/${best.year}`;
  } else { document.getElementById('kpiBest').textContent = '—'; document.getElementById('kpiBestInfo').textContent = ''; }
  if (worst){
    document.getElementById('kpiWorst').textContent = fmt(worst.value);
    document.getElementById('kpiWorstInfo').textContent = `${PT_MONTHS[worst.month-1]}/${worst.year}`;
  } else { document.getElementById('kpiWorst').textContent = '—'; document.getElementById('kpiWorstInfo').textContent = ''; }

  const kpiYOY = document.getElementById('kpiYOY');
  if (yoy!=null){
    const sign = yoy>=0 ? '+' : '';
    kpiYOY.textContent = `${sign}${yoy.toFixed(1)}% vs ano anterior (líquido)`;
    kpiYOY.className = 'delta ' + (yoy>=0? 'ok':'bad');
  } else {
    kpiYOY.textContent = 'Selecione ano e mês para ver o YoY';
    kpiYOY.className = 'delta';
  }
}

function renderCharts(state){
  const lineCtx = document.getElementById('lineTotals');
  const barCtx = document.getElementById('barPlatforms');

  const lineLabels = state.series.map(s=> `${PT_MONTHS[s.month-1].slice(0,3)}/${String(s.year).slice(2,4)}`);
  const lineData = state.series.map(s=> s.value);

  Chart.defaults.color = '#cbd5e1';
  Chart.defaults.borderColor = 'rgba(59, 130, 246, 0.2)';
  Chart.defaults.backgroundColor = 'rgba(59, 130, 246, 0.1)';

  if (LINE) LINE.destroy();
  LINE = new Chart(lineCtx, {
    type: 'line',
    data: { 
      labels: lineLabels, 
      datasets: [{ 
        label: `Total por mês (líquido • ${displayCurrency})`, 
        data: lineData, 
        tension: 0.4,
        borderColor: '#3b82f6',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        fill: true,
        pointBackgroundColor: '#3b82f6',
        pointBorderColor: '#ffffff',
        pointBorderWidth: 2,
        pointRadius: 6,
        pointHoverRadius: 8
      }]
    },
    options: { 
      responsive: true, 
      maintainAspectRatio: false,
      interaction: {
        intersect: false,
        mode: 'index'
      },
      plugins: {
        legend: {
          labels: {
            color: '#cbd5e1',
            font: {
              family: 'Inter',
              size: 13,
              weight: 500
            }
          }
        }
      },
      scales: { 
        y: { 
          beginAtZero: true,
          grid: {
            color: 'rgba(59, 130, 246, 0.1)'
          },
          ticks: {
            color: '#94a3b8',
            font: {
              family: 'Inter',
              size: 12
            }
          }
        },
        x: {
          grid: {
            color: 'rgba(59, 130, 246, 0.1)'
          },
          ticks: {
            color: '#94a3b8',
            font: {
              family: 'Inter',
              size: 12
            }
          }
        }
      }
    }
  });

  const barLabels = state.platforms.map(p=> p.name);
  const barData = state.platforms.map(p=> p.val);
  const barColors = state.platforms.map((_, i) => {
    const hue = (i * 137.5) % 360;
    return `hsl(${hue}, 70%, 60%)`;
  });

  if (BAR) BAR.destroy();
  BAR = new Chart(barCtx, {
    type: 'bar',
    data: { 
      labels: barLabels, 
      datasets: [{ 
        label: `Por plataforma (líquido • ${displayCurrency})`, 
        data: barData,
        backgroundColor: barColors.map(c => c.replace('60%', '50%')),
        borderColor: barColors,
        borderWidth: 2,
        borderRadius: 8,
        borderSkipped: false
      }]
    },
    options: { 
      responsive: true, 
      maintainAspectRatio: false, 
      indexAxis: 'y',
      interaction: {
        intersect: false,
        mode: 'index'
      },
      plugins: {
        legend: {
          labels: {
            color: '#cbd5e1',
            font: {
              family: 'Inter',
              size: 13,
              weight: 500
            }
          }
        }
      },
      scales: { 
        x: { 
          beginAtZero: true,
          grid: {
            color: 'rgba(59, 130, 246, 0.1)'
          },
          ticks: {
            color: '#94a3b8',
            font: {
              family: 'Inter',
              size: 12
            }
          }
        },
        y: {
          grid: {
            color: 'rgba(59, 130, 246, 0.1)'
          },
          ticks: {
            color: '#94a3b8',
            font: {
              family: 'Inter',
              size: 12
            }
          }
        }
      }
    }
  });
}

function render(){
  const state = compute();
  renderKpis(state);
  renderCharts(state);
  renderTables(state);
}

load();
</script>
</body>
</html>